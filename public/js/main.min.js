/*! teechio-dashboard-260.2014-11-16 */
!function(a){"use strict";var b=angular.module("teechioDashboard",["ngRoute"]),c="/public/";b.config(function(a){a.startSymbol("{[").endSymbol("]}")}),b.config(function(a,b){a.when("/",{templateUrl:c+"partials/home.html",controller:"DashboardController"}).when("/walkthrough",{templateUrl:c+"partials/walkthrough.html",controller:"WalkthroughController"}).when("/apps/:id",{templateUrl:c+"partials/applications.html",controller:"ApplicationsController"}).when("/settings",{templateUrl:c+"partials/settings.html",controller:"SettingsController"}),b.html5Mode(!0)}),b.factory("$acache",["$cacheFactory",function(){return{get:function(a){var b=localStorage.getItem(a);try{return b=JSON.parse(localStorage.getItem(a))}catch(c){return b}},put:function(a,b){"string"==typeof b?localStorage.setItem(a,b):localStorage.setItem(a,JSON.stringify(b))},remove:function(a){localStorage.removeItem(a)}}}]),a.teechioDashboard=b}(window,document),teechioDashboard.controller("AccountController",["$scope","$http",function(a,b){a.register=function(){a.$emit("nprogress:loading",{state:"start"}),b.post("/api/account/register",a.account).success(function(){location.href="/walkthrough"}).error(function(b){a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:".login-container",clazz:"error",msg:b.message})})},a.auth=function(){a.$emit("nprogress:loading",{state:"start"}),b.post("/auth",a.account).success(function(){location.href="/"}).error(function(b){a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:".login-container",clazz:"error",msg:b.message})})},a.sendReset=function(){a.$emit("nprogress:loading",{state:"start"}),b.get("/api/account/forgot?email="+a._forgot.email).success(function(){a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:"#password-recovery",clazz:"success",msg:"You've got mail! We sent you an email with instructions on how to reset your password."})}).error(function(b){a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:"#password-recovery",clazz:"error",msg:b.message})})},a.doReset=function(){a.$emit("nprogress:loading",{state:"start"}),b.post("/api/account/doreset",a._forgot).success(function(){location.href="/"}).error(function(b){a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:".resetpwd-container",clazz:"error",msg:b.message})})}}]),teechioDashboard.controller("ApplicationsController",["$scope","$route","$routeParams","$http","$acache",function(a,b,c,d,e){a.currentPage=b.current.$$route.controller,a.dashboard={apikey:_ukey,appid:c.id,appname:"",apicalls:0,created:""},a.console={path:"",key:"",method:"GET",endpoint:"http://api.teech.io/",payload:"",query:""},a.apihost="http://api.teech.io/",a.init=function(){a.loadStorage(),d.get("/account/app/"+c.id).success(function(b){a.dashboard.appname=b.name,a.dashboard.created=b.created}).error(function(){});e.get("_usettings");a.typed={endpoint:"http://api.teech.io/"}},a.deleteApp=function(b){a.dashboard.appname===a._deleteApp.name?d.delete("/account/app/"+b).success(function(){location.href="/"}).error(function(){}):a.$emit("ux:notification",{container:"#delete-modal",clazz:"error",msg:"Ooops! This is not the name of your app."})},a.switchTab=function(b){a.sectionTab=b,a.console={path:"",key:"",method:"GET",endpoint:"http://api.teech.io/",payload:"",query:""},a.typed.endpoint=a.console.endpoint},a.buildEndpoint=function(){a.typed.endpoint=a.console.endpoint+(a.console.path||"")+"/"+(a.console.key||""),a.typedPath=(a.console.path||"")+"/"+(a.console.key||""),"search"==a.sectionTab&&(a.typed.endpoint=a.console.endpoint+(a.console.path||"")+"?query="+(a.console.query||""),a.typedPath=a.console.path+"?query="+(a.console.query||""))},a.switchMethod=function(b){a.console.method=b},a.makeCall=function(){function b(b,c){var d=b?{error:!0}:!0;a.$emit("nprogress:loading",{state:"done"}),a.$emit("animate:console",d),a.output={status:c.headers.status,length:c.headers["Content-Length"],type:c.headers["Content-Type"],date:c.headers.date,body:JSON.stringify(c.body,void 0,2)}}a.$emit("nprogress:loading",{state:"start"});var c=a.typedPath;"/"==c.charAt(c.length-1)&&(a.typedPath=c.substring(0,c.length-1));var e={method:a.console.method,url:"/console/call/?path="+encodeURIComponent(a.typedPath),headers:{"Teech-REST-API-Key":a.dashboard.apikey,"Teech-Application-Id":a.dashboard.appid}};("POST"==e.method||"PUT"==e.method)&&(e["Content-Type"]="application/json",e.data=a.console.payload),d(e).success(function(a){b(null,a)}).error(function(a){b(!0,a)})},a.loadWeeklyChart=function(){var b=dimple.newSvg("#app-usage-chart","100%","100%");d3.json("/account/stats/app/"+c.id).get(function(c,d){if(c)return console.warn(c);var e=[],f=7,g=0,h=0;week=1,angular.forEach(d.apis,function(c){if(h++,0==f&&(e.push({week:"Week "+week,calls:g}),a.dashboard.apicalls+=g,a.$apply(),week++,f=7,g=0),g+=c,f--,_.size(d.apis)==h){var i=new dimple.chart(b,e);i.setBounds(30,15,"90%","90%");var j=i.addCategoryAxis("x","week"),k=i.addMeasureAxis("y","calls");i.addColorAxis("calls","#7E438D"),i.addColorAxis("week","#1fbba6");{i.addSeries(null,dimple.plot.line)}i.draw(),k.titleShape.remove(),j.titleShape.remove()}})})},a.loadStorage=function(){var b={method:"GET",url:"/console/call/?path=files",headers:{"Teech-REST-API-Key":a.dashboard.apikey,"Teech-Application-Id":a.dashboard.appid}};d(b).success(function(b){a.files=b.body})},a.deleteFile=function(b,c){var e={method:"DELETE",url:"/console/call/?path=files/"+c,headers:{"Teech-REST-API-Key":a.dashboard.apikey,"Teech-Application-Id":a.dashboard.appid}};d(e).success(function(){a.$emit("faden:remove",{el:"tr#"+b,container:"#files-list"})})},a.init()}]),teechioDashboard.controller("DashboardController",["$scope","$route","$http","$acache",function(a,b,c,d){a.currentPage=b.current.$$route.controller,a.applications=[],a.stats={api:{calls:0,percent:0},events:{calls:0,percent:0},storage:{data:0,percent:0}},a.init=function(){a.loadApps(),a.loadStats(),a.disabledWalkthrough=d.get("disabledWalkthrough")},a.disableWalkthrough=function(){a.disabledWalkthrough=!0,d.put("disabledWalkthrough",!0)},a.createApplication=function(){c.post("/account/app",a._app).success(function(b){a.applications.unshift(b),a.$emit("ux:form:clear",{form:"#new-application"})}).error(function(b){var c="error";"not_allowed_plan"==b.error&&(c="warning"),a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:"#new-application",clazz:c,msg:b.message})})},a.loadApps=function(){c.get("/account/apps").success(function(b){angular.forEach(b,function(b){a.applications.push(b)})}).error(function(){})},a.loadStats=function(){c.get("/account/stats/apps").success(function(b){a.stats.api.calls=b.api,a.stats.events.calls=b.push,$("p.loader",".api-calls").fadeOut("slow",function(){$("span.stats",".api-calls").fadeIn("slow")})}).error(function(){}),c.get("/account/stats/storage").success(function(b){a.stats.storage.data=Math.round(b.container_size),$("p.loader",".storage-usage").fadeOut("slow",function(){$("span.stats",".storage-usage").fadeIn("slow")})}).error(function(){})},a.loadSettings=function(){c.get("/api/account/settings").success(function(b){d.put("_usettings",b);var c={calls:5e4,storage:1024};a.stats.api.percent=(a.stats.api.calls/c.calls*100).toFixed(1),a.stats.storage.percent=(a.stats.storage.data/c.storage*100).toFixed(1)})},a.init()}]),teechioDashboard.controller("SettingsController",["$scope","$route","$http","$acache",function(a,b,c){a.currentPage=b.current.$$route.controller,a.settings={},a.plans={},a.init=function(){a.loadSettings()},a.loadSettings=function(){a.$emit("nprogress:loading",{state:"start"}),c.get("/api/account/settings").success(function(b){a.$emit("nprogress:loading",{state:"done"}),a.settings=b.settings,a.plans=b.plans,a._profile={firstname:b.settings.firstname,lastname:b.settings.lastname}}).error(function(){a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:"div#service-notification",clazz:"warning",msg:"We were unable to retrieve your settings. Something went wrong with our servers.",timeout:15e3})})},a.updateFullname=function(){c.put("/api/account/fullname",a._profile).success(function(b){a.$emit("ux:notification",{container:"form.profile-settings",clazz:"success",msg:b.message})}).error(function(){})},a.updatePassword=function(){c.put("/api/account/changepwd",a._password).success(function(b){a.$emit("ux:notification",{container:"form.change-password",clazz:"success",msg:b.message})}).error(function(b){a.$emit("ux:notification",{container:"form.change-password",clazz:"error",msg:b.message})})},a.saveCCard=function(){function b(b,d){d.error?(a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:"#ccard-selection",clazz:"error",msg:err.error.message})):c.post("/billing/customers/"+a.settings.subscription.cusid+"/cards",{token:d.id}).success(function(){a.settings.card.last4=g,a.settings.default_card=d.id,a.$emit("ux:form:clear",{form:"form.ccard-new"}),a.$emit("toggle:slide",{el:"#ccard-selection",pos:"up"}),a.$emit("nprogress:loading",{state:"done"})}).error(function(b){a.$emit("nprogress:loading",{state:"done"}),a.$emit("ux:notification",{container:"#ccard-selection",clazz:"error",msg:b.error.message})})}a.$emit("nprogress:loading",{state:"start"});var d=a._ccard,e=d.exp.substr(0,2),f=d.exp.substr(3,d.exp.length),g=d.number.substr(d.number.length-4,d.number.length);Stripe.setPublishableKey("pk_test_6nU4oYjqeP30ZjrPOcEltmT2"),Stripe.card.createToken({number:d.number,cvc:d.cvc,exp_month:e,exp_year:f},b)},a.changePlan=function(b,d){a.$emit("nprogress:loading",{state:"start"}),c.post("/billing/customers/"+a.settings.subscription.cusid+"/subscriptions",{subscription:a.settings.subscription.id,plan:d}).success(function(){a.settings.subscription.plan=b,a.$emit("nprogress:loading",{state:"done"})}).error(function(b){a.$emit("ux:notification",{container:".change-plan",clazz:"warning",msg:b.error.error.message||b.error.message}),a.$emit("nprogress:loading",{state:"done"})})},a.init()}]),teechioDashboard.controller("WalkthroughController",["$scope","$route",function(a,b){a.currentPage=b.current.$$route.controller}]),teechioDashboard.directive("setConsoleMethod",function(){return function(a,b,c){b.click(function(){"post"==c.setConsoleMethod&&(a.typedEndpoint=a.console.endpoint+a.console.path),a.$apply()})}}),teechioDashboard.directive("consoleEndpointHint",function(){return function(a,b){var c=["classes","users","modules","materials","enrollments","assessments","assignments","submissions","files"];b.autocomplete({source:c,select:function(b,c){a.hintDoc="classes"==c.item.value?"objects":c.item.value,a.console.path=c.item.value,$(".hint-box").slideDown()},close:function(){a.$apply(function(){a.buildEndpoint()})}}),b.focusin(function(){$(".hint-box").slideUp()})}}),teechioDashboard.directive("animateConsole",function(){return function(a){a.$on("animate:console",function(a,b){var c=angular.element("#api-output");c.is(":visible")||c.slideDown("fast"),c.children("pre").fadeOut("fast",function(){c.children("pre").fadeIn("fast"),b.error?c.addClass("error"):c.removeClass("error")}),b.error||angular.element("html, body").animate({scrollTop:c.offset().top},800)})}}),teechioDashboard.directive("bodyId",function(){return{restrict:"A",link:function(a){a.$watch("currentPage",function(a){"DashboardController"==a&&$("body").attr("id","dashboard-page"),"WalkthroughController"==a&&$("body").attr("id","walkthrough-page"),"ApplicationsController"==a&&$("body").attr("id","applications-page"),"SettingsController"==a&&$("body").attr("id","settings-page")})}}}),teechioDashboard.directive("walkthrough",function(){return function(a,b){$(".next-step-btn",b).click(function(){var a=$(this).data("href"),c=$(this).parents(".step");c.fadeOut("fast",function(){$("div"+a,b).fadeIn()}),$("i",".walkthrough-index").removeClass("active"),$("i"+a,".walkthrough-index").addClass("active")})}}),teechioDashboard.directive("notificationPop",function(){return function(a){a.$on("ux:notification",function(a,b){var c=$(".notification",b.container),d=b.speed?b.speed:"fast",e=b.timeout?b.timeout:5e3;c.removeClass("success error warning").addClass(b.clazz).html(b.msg).slideDown(d,function(){setTimeout(function(){c.slideUp()},e)})})}}),teechioDashboard.directive("nProgress",function(){return function(a){a.$on("nprogress:loading",function(a,b){switch(b.state){case"start":NProgress.start();break;case"done":NProgress.done()}})}}),teechioDashboard.directive("selectOnFocus",function(){return function(a,b){b.focus(function(){$(this).select()}),b.mouseup(function(a){a.preventDefault()})}}),teechioDashboard.directive("fadeNRemove",function(){return function(a){a.$on("faden:remove",function(a,b){var c=b.speed?b.speed:"fast";$(b.container).find(b.el).fadeOut(c,function(){$(this).remove()})})}}),teechioDashboard.directive("showOrHide",function(){return{restrict:"A",link:function(a,b,c){b.click(function(){$(c.showOrHide).slideToggle("fast",function(){})})}}}),teechioDashboard.directive("activeHighlight",function(){return{restrict:"A",link:function(a,b){$("a",b).click(function(){$("a.active",b).removeClass("active"),$(this).addClass("active")})}}}),teechioDashboard.directive("slideToggle",function(){return function(a){a.$on("toggle:slide",function(a,b){var c=b.speed?b.speed:"fast";"up"==b.pos?$(b.el).slideUp(c,function(){}):$(b.el).slideDown(c,function(){})})}}),teechioDashboard.directive("clearForm",function(){return function(a){a.$on("ux:form:clear",function(a,b){$("input, textarea",b.form).not(":button, :submit").val("").removeAttr("checked").removeAttr("selected"),$(".modal").modal("hide")})}}),teechioDashboard.directive("fileUploader",function(){return{restrict:"A",link:function(a,b,c){a._queue=[],a._queueSize=0,a._uprogress=!1;var d={runtimes:"html5",browse_button:c.id,multipart:!1,drop_element:"drop-area",max_file_size:"64mb",url:"/console/upload",headers:{"Teech-REST-API-key":a.dashboard.apikey,"Teech-Application-Id":a.dashboard.appid}},e=new plupload.Uploader(d);e.bind("Init",function(){}),e.init(),e.bind("FilesAdded",function(b,c){angular.forEach(c,function(b){var c={id:b.id,name:b.name,size:plupload.formatSize(b.size),synced:"not-synced"};a.$apply(function(){a._queue.push(b),a._queueSize+=1,a.files&&a.files.unshift(c)})})}),e.bind("BeforeUpload",function(){}),e.bind("UploadProgress",function(b,c){a.$apply(function(){a._uprogress=!0}),$("span.percentage","#uploader-progress").html(c.percent)}),e.bind("FileUploaded",function(b,c,d){d&&($("#upload-modal").modal("hide"),$("span.percentage","#uploader-progress").html(0),a.$apply(function(){a.files.shift(),a.files.unshift(JSON.parse(d.response)),a._queue=[],a._queueSize=0,a._uprogress=!1})),b.refresh()}),e.bind("Error",function(a,b){$(".notification","#uploader-progress").addClass("error").html(b.message).slideDown("fast"),a.refresh()}),a.startUpload=function(){e.start()},a.removeFile=function(b,c){e.removeFile(c.gfile),a.files.splice(b,1)},$("#upload-modal").on("hidden.bs.modal",function(){$("span.percentage","#uploader-progress").html(0),$(".notification","#uploader-progress").hide(),a.$apply(function(){a._queue=[],a._queueSize=0,a._uprogress=!1})})}}});